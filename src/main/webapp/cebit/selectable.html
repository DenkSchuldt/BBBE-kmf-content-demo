<!DOCTYPE html>
<html>
<head>
<title>WebRTC selectable demo</title>
<script src="../js/kws-content-api.js"></script>
<script src="../lib/adapter.js"></script>
<script src="../lib/Console.js"></script>
<script>
	var Attr = {
		NAME : "name",
	}

	var Command = {
		GET_PARTICIPANTS : "getParticipants",
		SELECT : "selectParticipant",
		CONNECT : "connectParticipant",
	}

	var Event = {
		ON_JOINED : "onJoined",
		ON_UNJOINED : "onUnjoined",
	}

	function Participant() {
		this.id = null;
		this.name = null;
	}

	function addParticipant(participant, selectName) {
		var participants = document.getElementById(selectName);
		var opt = document.createElement('option');
		opt.innerHTML = participant.id + " - " + participant.name;
		opt.value = participant.id;
		participants.appendChild(opt);
	}

	function removeParticipant(participant, selectName) {
		var participants = document.getElementById(selectName);
		for (i = 0; i < participants.length; i++) {
			if (participants.options[i].value == participant.id) {
				participants.remove(i);
				break;
			}
		}
	}

	function removeAllParticipants(selectName) {
		var participants = document.getElementById(selectName);
		while (participants.options.length > 0) {
			participants.remove(0);
		}
	}

	/* Events */
	function onJoined(participant) {
		addParticipant(participant, 'participants');
		addParticipant(participant, 'orig');
		addParticipant(participant, 'dest');
	}

	function onUnjoined(participant) {
		removeParticipant(participant, 'participants');
		removeParticipant(participant, 'orig');
		removeParticipant(participant, 'dest');
	}

	/* Commands */
	function getParticipants() {
		conn.execute(Command.GET_PARTICIPANTS, "", function(error, result) {
			console.log("error: " + error + ", result: " + result);

			removeAllParticipants('participants');
			removeAllParticipants('orig');
			removeAllParticipants('dest');

			participantsList = JSON.parse(result);
			console.log("participantsList: " + participantsList);
			participantsList.forEach(function(item) {
				addParticipant(item, 'participants');
				addParticipant(item, 'orig');
				addParticipant(item, 'dest');
			});
		});
	}

	function secect() {
		var partSelected = document.getElementById("participants").value;
		console.log("Participant selected: " + partSelected);
		conn.execute(Command.SELECT, partSelected, function(error, result) {
			console.log("error: " + error + ", result: " + result);
		});
	}

	function connectParticipants() {
		var origId = document.getElementById("orig").value;
		var destId = document.getElementById("dest").value;
		var list = [ origId, destId ];
		conn.execute(Command.CONNECT, JSON.stringify(list), function(error,
				result) {
			console.log("error: " + error + ", result: " + result);
		});
	}

	var conn = null;

	function terminate() {
		if (conn == null) {
			console.log("Conn is not created");
			return;
		}

		document.getElementById("terminate").disabled = true;

		conn.terminate();
		console.log("Connection terminated by user");
		remoteVideo.style.background = "";

		document.getElementById("start").disabled = false;
	}

	function initConnection(conn) {
		document.getElementById("terminate").disabled = false;

		conn.on("start", function(event) {
			document.getElementById("terminate").disabled = false;
		});

		conn.on("terminate", function(event) {
			console.log("Connection terminated");
		});

		conn.on("localstream", function(event) {
			console.info("LocalStream set");
		});

		conn.on("remotestream", function(event) {
			console.info("RemoteStream set");
		});

		conn.on("mediaevent", function(event) {
			console
					.info("MediaEvent: (" + event.type + ", " + event.data
							+ ")");

			if (Event.ON_JOINED == event.type) {
				var part = JSON.parse(event.data);
				onJoined(part);
			} else if (Event.ON_UNJOINED == event.type) {
				var part = JSON.parse(event.data);
				onUnjoined(part);
			}
		});

		conn.on("error", function(error) {
			console.error("Error: " + error.message);
			terminate();
		});
	}

	function start() {
		document.getElementById("start").disabled = true;

		var localVideo = document.getElementById("localVideo");
		var remoteVideo = document.getElementById("remoteVideo");
		localVideo.poster = "../img/transparent-1px.png";
		localVideo.style.background = "center transparent url('../img/spinner.gif') no-repeat";
		remoteVideo.poster = "../img/transparent-1px.png";
		remoteVideo.style.background = "center transparent url('../img/spinner.gif') no-repeat";

		var options = {
			iceServers : [],
			localVideoTag : "localVideo",
			remoteVideoTag : "remoteVideo"
		};

		var endpoint = "../selectable?" + Attr.NAME + "="
				+ document.getElementById("name").value;
		try {
			conn = new kwsContentApi.KwsWebRtcContent(endpoint, options);
			console.log("Creating connection to " + endpoint);
			initConnection(conn);
		} catch (error) {
			document.getElementById("start").disabled = false;
			console.error(error.message);
		}
	}

	window.onbeforeunload = function() {
		terminate();
		return "";
	}
</script>
</head>

<body>
	<h1>WebRTC selectable demo</h1>
	Name:
	<input id="name" size="name" type="text" />
	<br />
	<button id="start" onclick="start();">Start</button>
	<button id="terminate" disabled onclick="terminate();">Terminate</button>

	<button id="getParticipants" onclick="getParticipants();">Get
		participants</button>

	<br /> Participants:
	<br />
	<select id="participants"></select>
	<button id="secect" onclick="secect();">Select</button>

	<br /> orig:
	<select id="orig"></select> " dest:"
	<select id="dest"></select>
	<button id="connect" onclick="connectParticipants();">Connect
		participants</button>

	<br />
	<video id="localVideo" autoplay controls width="480px" height="360px"></video>
	<video id="remoteVideo" autoplay controls width="480px" height="360px"></video>
</body>
</html>
